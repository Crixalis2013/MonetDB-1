statement ok
START TRANSACTION

statement ok
CREATE TABLE allnewtriples (id integer NOT NULL, subject integer NOT
NULL, predicate integer NOT NULL, "object" integer NOT NULL, explicit
boolean NOT NULL, CONSTRAINT unique_key UNIQUE(subject, predicate, "object"))

statement ok
CREATE INDEX allnewtriples_subject_idx ON allnewtriples (subject)

statement ok
CREATE INDEX allnewtriples_predicate_idx ON allnewtriples (predicate)

statement ok
CREATE INDEX allnewtriples_object_idx ON allnewtriples ("object")

query TITI rowsort
SELECT idxs.name, idxs."type", keys.name, keys."type"
FROM sys.idxs LEFT JOIN sys.keys on idxs.name = keys.name
----
84 values hashing to aca252ae38ab8879e6e119df7736fb5e

query TITI rowsort
SELECT idxs.name, idxs."type", keys.name, keys."type"
FROM sys.idxs JOIN sys.keys on idxs.name = keys.name
----
72 values hashing to 605c876e5adbcc987c4a0294b82e9da6

statement ok
/* test elimination of distinct restriction on aggregates */
create table dummyme (a int primary key, b int)

statement ok
insert into dummyme values (1,1), (2,1), (3,1)

query T nosort
/* eliminated */
plan select count(distinct a) from dummyme
----
project (
| group by (
| | table("sys"."dummyme") [ "dummyme"."a" NOT NULL HASHCOL  ] COUNT 
| ) [  ] [ "sys"."count" no nil ("dummyme"."a" NOT NULL HASHCOL ) NOT NULL as "%1"."%1" ]
) [ "%1"."%1" NOT NULL ]

query T nosort
PLAN select count(distinct a) from dummyme group by b
----
project (
| group by (
| | table("sys"."dummyme") [ "dummyme"."a" NOT NULL HASHCOL , "dummyme"."b" ] COUNT 
| ) [ "dummyme"."b" ] [ "sys"."count" no nil ("dummyme"."a" NOT NULL HASHCOL ) NOT NULL as "%1"."%1" ]
) [ "%1"."%1" NOT NULL ]

query T nosort
/* not eliminated */
plan select count(distinct b) from dummyme
----
project (
| group by (
| | table("sys"."dummyme") [ "dummyme"."b" ] COUNT 
| ) [  ] [ "sys"."count" unique  no nil ("dummyme"."b") NOT NULL as "%1"."%1" ]
) [ "%1"."%1" NOT NULL ]

query T nosort
PLAN select count(distinct a + 1) from dummyme
----
project (
| group by (
| | project (
| | | table("sys"."dummyme") [ "dummyme"."a" NOT NULL HASHCOL  ] COUNT 
| | ) [ bigint["dummyme"."a" NOT NULL HASHCOL ] NOT NULL as "%3"."%3", "sys"."sql_add"("%3"."%3" NOT NULL, bigint "1") NOT NULL as "%2"."%2" ]
| ) [  ] [ "sys"."count" unique  no nil ("%2"."%2" NOT NULL) NOT NULL as "%1"."%1" ]
) [ "%1"."%1" NOT NULL ]

query T nosort
PLAN select count(distinct a + b) from dummyme
----
project (
| group by (
| | project (
| | | table("sys"."dummyme") [ "dummyme"."a" NOT NULL HASHCOL , "dummyme"."b" ] COUNT 
| | ) [ bigint["dummyme"."a" NOT NULL HASHCOL ] NOT NULL as "%3"."%3", bigint["dummyme"."b"] as "%4"."%4", "sys"."sql_add"("%3"."%3" NOT NULL, "%4"."%4") as "%2"."%2" ]
| ) [  ] [ "sys"."count" unique  no nil ("%2"."%2") NOT NULL as "%1"."%1" ]
) [ "%1"."%1" NOT NULL ]

query T nosort
PLAN select count(distinct abs(a)) from dummyme
----
project (
| group by (
| | project (
| | | table("sys"."dummyme") [ "dummyme"."a" NOT NULL HASHCOL  ] COUNT 
| | ) [ "sys"."abs"("dummyme"."a" NOT NULL HASHCOL ) NOT NULL as "%2"."%2" ]
| ) [  ] [ "sys"."count" unique  no nil ("%2"."%2" NOT NULL) NOT NULL as "%1"."%1" ]
) [ "%1"."%1" NOT NULL ]

statement ok
ROLLBACK

