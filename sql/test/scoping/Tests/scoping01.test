statement ok
create table tmp1("optimizer" integer, s string)

statement ok
insert into tmp1 values(1,'hello'),(2,'world')

query I rowsort
select "optimizer" from tmp1
----
1
2

query TI rowsort
select sys."optimizer", "optimizer" from tmp1
----
default_pipe
1
default_pipe
2

statement ok
CREATE table tmp2("optimizer" integer, s string)

statement ok
insert into tmp2 values(3,'another'),(4,'test')

query II rowsort
select tmp1."optimizer", tmp2."optimizer" from sys.tmp1, sys.tmp2
----
1
3
1
4
2
3
2
4

query I rowsort
SELECT MAX("optimizer") FROM tmp1
----
2

statement error
CREATE OR REPLACE FUNCTION tests_scopes1(i INT) RETURNS INT
BEGIN
	DECLARE i int

statement error
	RETURN i

statement error
END

statement error
SELECT tests_scopes1(vals) FROM (VALUES (1),(2),(3)) AS vals(vals)

statement error
CREATE OR REPLACE FUNCTION tests_scopes2("optimizer" INT) RETURNS INT
BEGIN
	DECLARE j int

statement error
	SET j = "optimizer"

statement error
	RETURN j

statement error
END

statement error
SELECT tests_scopes2(vals) FROM (VALUES (1),(2),(3)) AS vals(vals)

statement error
with a("optimizer") as (select 4) select "optimizer" from tmp1, a

statement ok
DROP TABLE tmp1

statement ok
DROP TABLE tmp2

statement error
DROP FUNCTION tests_scopes1(INT)

statement error
DROP FUNCTION tests_scopes2(INT)

statement error
DECLARE "current_schema" string

statement error
DECLARE "sys"."current_schema" string

statement error
with a(a) as (select 1), a(a) as (select 2) select 1

query I rowsort
with a(a) as (with a(a) as (select 1) select 2) select a from a
----
2

statement error
CREATE OR REPLACE FUNCTION tests_scopes3(input INT) RETURNS STRING
BEGIN
	IF input = 1 THEN
		DECLARE "optimizer" string

statement error
		SET "optimizer" = 'anything'

statement error
	END IF

statement error
	RETURN SELECT "optimizer"

statement error
END

statement error
SELECT tests_scopes3(0), tests_scopes3(1)

statement ok
SET "optimizer" = 'default_pipe'

statement error
DROP FUNCTION tests_scopes3(INT)

statement error
create function tests_scopes4() returns int begin declare table y (a int, b int); return select y; end

statement error
create function tests_scopes4() returns table (i integer, s string) begin return select tmp2; end

statement ok
CREATE table tmp2(i integer, s string)

statement ok
insert into tmp2 values(3,'another'),(4,'test')

statement ok
create function tests_scopes4() returns table (i integer, s string) begin return tmp2; end

query IT rowsort
select * from tests_scopes4()
----
3
another
4
test

statement error
DROP TABLE tmp2

statement ok
DROP FUNCTION tests_scopes4

statement ok
DROP TABLE tmp2

statement error
CREATE OR REPLACE FUNCTION scoping(input INT) RETURNS INT
BEGIN
	DECLARE x int

statement error
	SET x = 1

statement error
	IF input = 2 THEN
		DECLARE x int

statement error
		SET x = 2

statement error
	ELSE
		IF input = 3 THEN
			SET x = 3

statement error
		END IF

statement error
	END IF

statement error
	RETURN x

statement error
END

statement error
SELECT scoping(vals) FROM (VALUES (1),(2),(3)) AS vals(vals)

statement error
DROP FUNCTION scoping(INT)

statement error
CREATE OR REPLACE FUNCTION scoping2(input INT) RETURNS INT
BEGIN
	DECLARE TABLE z (a int)

statement error
	INSERT INTO z VALUES (1)

statement error
	IF input = 2 THEN
		DECLARE TABLE z (a int)

statement error
		INSERT INTO z VALUES (2)

statement error
	ELSE
		IF input = 3 THEN
			TRUNCATE z

statement error
			INSERT INTO z VALUES (3)

statement error
		END IF

statement error
	END IF

statement error
	RETURN SELECT a FROM z

statement error
END

statement error
SELECT scoping2(vals) FROM (VALUES (1),(2),(3),(4)) AS vals(vals)

statement error
CREATE OR REPLACE FUNCTION scoping2(input INT) RETURNS INT
BEGIN
	IF input = 2 THEN
		DECLARE TABLE z (a int)

statement error
		DECLARE TABLE z (a int)

statement error
	END IF

statement error
	RETURN SELECT a FROM z

statement error
END

statement error
DROP FUNCTION scoping2(INT)

statement ok
CREATE TABLE atest (a int)

statement ok
INSERT INTO atest VALUES (1)

statement error
CREATE OR REPLACE FUNCTION scoping3() RETURNS TABLE(a int)
BEGIN
	DECLARE TABLE atest (a int)

statement ok
	INSERT INTO atest VALUES (2)

statement error
	RETURN atest

statement error
END

query I rowsort
SELECT a FROM atest
----
1
2

statement error
SELECT a FROM scoping3()

statement error
CREATE OR REPLACE FUNCTION scoping4() RETURNS TABLE(a int)
BEGIN
	DECLARE tableydoesntexist int

statement error
	RETURN tableydoesntexist

statement error
END

statement error
CREATE OR REPLACE FUNCTION scoping4() RETURNS TABLE(a int)
BEGIN
	DECLARE TABLE mytable (a int)

statement error
	RETURN mytable, mytable

statement error
END

statement error
CREATE OR REPLACE FUNCTION scoping4() RETURNS INT
BEGIN
	RETURN idontexist

statement error
END

statement error
CREATE OR REPLACE FUNCTION scoping4() RETURNS INT
BEGIN
	DECLARE idoexist int

statement error
	RETURN idoexist, idoexist

statement error
END

statement error
CREATE OR REPLACE FUNCTION scoping4() RETURNS INT
BEGIN
	DECLARE TABLE z (a int)

statement error
	RETURN VALUES (z)

statement error
END

statement ok
DROP TABLE atest

statement error
DROP FUNCTION scoping3

